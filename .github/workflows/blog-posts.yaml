name: Latest blog posts from Hashnode

on:
  schedule:
    - cron: '0 * * * *'  # every hour
  workflow_dispatch:

jobs:
  update-readme:
    name: Update README with latest blog posts
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Add permission to write to repository contents

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'
      
      - name: Create blog posts file
        run: |
          echo "Fetching blog posts using Hashnode GraphQL API..."
          
          # Create a file to fetch posts using GraphQL
          cat > fetch-posts.js << 'EOL'
          const https = require('https');
          const fs = require('fs');
          
          const query = `
            {
              publication(id: "{{ secrets.PAT }}") {
                id
                posts(first: 5) {
                  edges {
                    node {
                      id
                      title
                      brief
                      publishedAt
                      coverImage {
                        url
                      }
                    }
                  }
                }
              }
            }
          `;
          
          const options = {
            hostname: 'gql.hashnode.com',
            path: '/',
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json',
            }
          };
          
          // Function to try fetching with retries
          function fetchWithRetry(data, retries = 3, delay = 3000) {
            return new Promise((resolve, reject) => {
              console.log(`Attempt to fetch posts, retries left: ${retries}`);
              
              const req = https.request(options, (res) => {
                console.log(`Status code: ${res.statusCode}`);
                
                if (res.statusCode === 429 && retries > 0) {
                  console.log(`Rate limited. Retrying after ${delay}ms...`);
                  setTimeout(() => {
                    fetchWithRetry(data, retries - 1, delay * 1.5)
                      .then(resolve)
                      .catch(reject);
                  }, delay);
                  return;
                }
                
                if (res.statusCode !== 200) {
                  return reject(new Error(`Status code: ${res.statusCode}`));
                }
                
                const chunks = [];
                res.on('data', chunk => chunks.push(chunk));
                res.on('end', () => {
                  const responseData = Buffer.concat(chunks).toString('utf-8');
                  resolve(responseData);
                });
              });
              
              req.on('error', err => {
                console.error(`Error fetching: ${err.message}`);
                if (retries > 0) {
                  console.log(`Retrying after ${delay}ms...`);
                  setTimeout(() => {
                    fetchWithRetry(data, retries - 1, delay * 1.5)
                      .then(resolve)
                      .catch(reject);
                  }, delay);
                } else {
                  reject(err);
                }
              });
              
              const requestBody = {
                query: query
              };
              
              req.write(JSON.stringify(requestBody));
              req.end();
            });
          }
          
          async function main() {
            try {
              console.log('Fetching posts from Hashnode...');
              const response = await fetchWithRetry();
              const data = JSON.parse(response);
              
              if (!data.data?.publication?.posts?.edges) {
                console.log('No posts found in the response.');
                return;
              }
              
              const posts = data.data.publication.posts.edges.map(edge => edge.node);
              console.log(`Found ${posts.length} posts.`);
              
              // Format posts for README
              const formattedPosts = posts.map(post => 
                `- [${post.title}](https://tanmaybansal.hashnode.dev/${post.slug})`
              ).join('\n');
              
              // Write to a file
              fs.writeFileSync('blog-posts.txt', formattedPosts);
              console.log('Blog posts written to blog-posts.txt');
            } catch (error) {
              console.error('Error:', error.message);
              process.exit(1);
            }
          }
          
          main();
          EOL
          
          # Run the Node.js script
          node fetch-posts.js
      
      - name: Update README
        if: success()
        run: |
          if [ -f "blog-posts.txt" ]; then
            # Read the blog posts
            BLOG_POSTS=$(cat blog-posts.txt)
            
            # If no blog posts were found, add a placeholder
            if [ -z "$BLOG_POSTS" ]; then
              BLOG_POSTS="- No blog posts found. Check back later!"
            fi
            
            # Update README using sed
            sed -i "/<!-- BLOG-POST-LIST:START -->/,/<!-- BLOG-POST-LIST:END -->/c\\
            <!-- BLOG-POST-LIST:START -->\n$BLOG_POSTS\n<!-- BLOG-POST-LIST:END -->" README.md
            
            # Check if there are changes
            if git diff --quiet README.md; then
              echo "No changes to README.md, skipping commit"
            else
              git config --global user.name "github-actions[bot]"
              git config --global user.email "github-actions[bot]@users.noreply.github.com"
              git add README.md
              git commit -m "Update latest blog posts"
              git push
            fi
          else
            echo "Blog posts file not found. Something went wrong."
            exit 1
          fi
